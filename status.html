<!DOCTYPE html>
<html lang="en" data-theme="night">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Status</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* THEME & COLOR VARIABLES */
        :root { --radius: 0.5rem; }
        
        [data-theme='night'] {
            --background: 222.2 84% 4.9%; --foreground: 210 40% 98%; --card: 222.2 84% 6.9%; --card-foreground: 210 40% 98%; --primary: 346.8 77.2% 49.8%; --primary-foreground: 355.7 100% 97.3%; --secondary: 217.2 32.6% 17.5%; --secondary-foreground: 210 40% 98%; --muted: 217.2 32.6% 17.5%; --muted-foreground: 215 20.2% 65.1%; --border: 217.2 32.6% 17.5%; --input: 217.2 32.6% 17.5%; --ring: 346.8 77.2% 49.8%;
        }
        [data-theme='day'] {
            --background: 0 0% 100%; --foreground: 224 71.4% 4.9%; --card: 0 0% 100%; --card-foreground: 224 71.4% 4.9%; --primary: 346.8 77.2% 49.8%; --primary-foreground: 355.7 100% 97.3%; --secondary: 210 40% 96.1%; --secondary-foreground: 224 71.4% 4.9%; --muted: 210 40% 96.1%; --muted-foreground: 215.4 16.3% 46.9%; --border: 214.3 31.8% 91.4%; --input: 214.3 31.8% 91.4%; --ring: 346.8 77.2% 49.8%;
        }
        [data-theme='afternoon'] {
            --background: 40 100% 95%; --foreground: 40 10% 20%; --card: 40 100% 100%; --card-foreground: 40 10% 20%; --primary: 35 100% 50%; --primary-foreground: 0 0% 100%; --secondary: 40 20% 90%; --secondary-foreground: 40 10% 20%; --muted: 40 20% 90%; --muted-foreground: 40 15% 50%; --border: 40 20% 85%; --input: 40 20% 90%; --ring: 35 100% 50%;
        }
        [data-theme='evening'] {
            --background: 260 50% 10%; --foreground: 260 50% 95%; --card: 260 50% 12%; --card-foreground: 260 50% 95%; --primary: 320 90% 60%; --primary-foreground: 0 0% 100%; --secondary: 260 50% 18%; --secondary-foreground: 260 50% 95%; --muted: 260 50% 18%; --muted-foreground: 260 30% 60%; --border: 260 50% 25%; --input: 260 50% 18%; --ring: 320 90% 60%;
        }
        
        /* GENERAL STYLING */
        body {
            font-family: 'Inter', sans-serif;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
        }
        .container-bg {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
        }
        .card {
            background-color: hsl(var(--card));
            color: hsl(var(--card-foreground));
        }
        .btn-primary {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }
        .btn-secondary {
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
        }
        input, select {
            background-color: hsl(var(--input));
            border-color: hsl(var(--border));
            color: hsl(var(--foreground));
        }
        input:focus, select:focus {
            outline: 2px solid hsl(var(--ring));
        }
        .text-primary-color {
            color: hsl(var(--primary));
        }
        
        /* FOOTER & NAVIGATION STYLES */
        footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: hsl(var(--card));
            border-top: 1px solid hsl(var(--border));
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.1);
            z-index: 100;
        }
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            color: hsl(var(--muted-foreground));
            text-decoration: none;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.5rem;
            border-radius: var(--radius);
            transition: color 0.2s, background-color 0.2s;
        }
        .nav-btn svg {
            width: 24px;
            height: 24px;
            transition: color 0.2s;
        }
        .nav-btn.active, .nav-btn:hover {
            color: hsl(var(--primary));
            background-color: hsl(var(--secondary));
        }
        .nav-btn.active svg, .nav-btn:hover svg {
            color: hsl(var(--primary));
        }
        .nav-btn span {
            line-height: 1;
        }
        
        /* SOS button specific styles */
        #sos-btn {
            color: hsl(var(--primary));
            font-weight: 600;
        }
        #sos-btn svg {
            color: hsl(var(--primary));
        }

        /* THEME TOGGLE BUTTON */
        #theme-toggle-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: hsl(var(--card));
            color: hsl(var(--foreground));
            border: 1px solid hsl(var(--border));
            border-radius: 9999px;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        #theme-toggle-btn:hover {
            background-color: hsl(var(--secondary));
        }
        #theme-toggle-btn .sun-icon { display: none; }
        [data-theme='day'] #theme-toggle-btn .moon-icon { display: none; }
        [data-theme='day'] #theme-toggle-btn .sun-icon { display: inline; }

        /* RUSH HOUR STYLING */
        .timeline-container {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            gap: 2px;
            height: 40px;
            border-radius: 12px;
            overflow: hidden;
        }
        .timeline-bar {
            height: 100%;
            background-color: hsl(var(--muted));
            transition: background-color 0.3s ease;
        }
        .timeline-bar.low {
            background-color: #4CAF50; /* Green */
        }
        .timeline-bar.medium {
            background-color: #FFC107; /* Orange */
        }
        .timeline-bar.high {
            background-color: #F44336; /* Red */
        }
        .timeline-labels {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            text-align: center;
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.5rem;
        }

        /* Modal Styles (New) */
        .modal {
            position: fixed;
            z-index: 150;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: hsl(var(--card));
            padding: 2.5rem 1.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal.visible .modal-content {
            transform: translateY(0);
        }
        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 2rem;
            color: hsl(var(--muted-foreground));
            cursor: pointer;
            line-height: 1;
        }
        .modal-content h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: hsl(var(--primary));
            margin-bottom: 0.5rem;
            text-align: center;
        }
        .modal-content p {
            font-size: 0.9rem;
            color: hsl(var(--foreground));
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .contact-info a {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 9999px;
            font-weight: 600;
            text-decoration: none;
            color: hsl(var(--foreground));
            background-color: hsl(var(--secondary));
            margin-bottom: 1rem;
            transition: background-color 0.2s ease;
        }
        .contact-info a:hover {
            background-color: hsl(var(--muted));
        }
        .contact-info a:first-of-type {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }
        .contact-info a:first-of-type:hover {
            background-color: hsl(var(--primary));
            opacity: 0.9;
        }

        /* Floating Chat Button */
        .chat-fab {
            position: fixed;
            bottom: 5.5rem; /* Above the footer navigation */
            right: 1.5rem;
            width: 56px;
            height: 56px;
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 101; /* Above footer, below modals */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            text-decoration: none;
        }
        .chat-fab:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
        }
        .chat-fab svg {
            width: 28px;
            height: 28px;
        }

        /* Custom button for exiting pool */
        .btn-exit-pool {
            background-color: transparent;
            color: hsl(var(--primary));
            border: 1px solid hsl(var(--primary));
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            margin-top: 1.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start p-4 pb-20 relative">

    <!-- Theme Toggle Button -->
    <button id="theme-toggle-btn" aria-label="Toggle theme">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="moon-icon">
            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9z"></path>
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sun-icon">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
    </button>
    
    <!-- Main Content Container -->
    <div class="container-bg w-full max-w-2xl mx-auto rounded-3xl p-6 md:p-10 mt-8">
        <h1 class="text-3xl md:text-4xl font-extrabold mb-8 text-center">Status & Travel Advisory</h1>
        
        <!-- Today's Status Card -->
        <div id="status-card" class="card rounded-2xl shadow-lg p-6 md:p-8 mb-8">
            <div class="flex items-center gap-4 mb-4">
                <svg id="status-icon" xmlns="http://www.w3.org/2000/svg" class="text-primary-color" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 16v-4"></path>
                    <path d="M12 8h.01"></path>
                </svg>
                <h2 class="text-2xl font-bold">Today's Travel Advisory</h2>
            </div>
            <p id="status-message" class="text-lg font-semibold text-center"></p>
            <ul id="status-reasons" class="list-disc list-inside mt-2 text-sm text-muted-foreground"></ul>
        </div>

        <!-- Trip Status Card -->
        <div class="card rounded-2xl shadow-lg p-6 md:p-8 mb-8">
            <h2 class="text-2xl font-bold text-primary-color mb-4">My Pool Status</h2>
            <div id="pool-status-container">
                <!-- This will be populated by JS -->
                <div class="flex items-center justify-between p-4 rounded-xl border-2 border-dashed" style="border-color: hsl(var(--border));">
                    <p class="text-lg" style="color: hsl(var(--muted-foreground));">You haven't joined any pools.</p>
                    <a href="booking.html">
                        <button class="px-4 py-2 btn-primary font-semibold rounded-xl hover:opacity-90 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2">
                            Find a Pool
                        </button>
                    </a>
                </div>
            </div>
        </div>

        <!-- Rush Hour Data Card -->
        <div class="card rounded-2xl shadow-lg p-6 md:p-8">
            <h2 class="text-2xl font-bold text-primary-color mb-4">Rush Hour Timings</h2>
            
            <p class="text-sm text-muted-foreground mb-4">
                Select a locality to view its predicted traffic levels throughout the day.
            </p>
            
            <!-- Locality Selector -->
            <div class="mb-6">
                <label for="locality-select" class="block text-sm font-medium mb-2">Select Locality in Tirupati:</label>
                <select id="locality-select" class="block w-full p-3 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-orange-500">
                    <option value="Tirupati">Tirupati</option>
                    <option value="Chandragiri">Chandragiri</option>
                    <option value="Srikalahasti">Srikalahasti</option>
                    <option value="Renigunta">Renigunta</option>
                </select>
            </div>

            <!-- Locality Info -->
            <div id="locality-info" class="card rounded-2xl p-4 mb-6" style="background-color: hsl(var(--secondary));">
                <p id="locality-description" class="text-muted-foreground text-sm"></p>
            </div>

            <!-- Rush Hour Timeline -->
            <div class="timeline-container relative">
                <div id="hour-0" class="timeline-bar" title="12 AM"></div>
                <div id="hour-1" class="timeline-bar" title="1 AM"></div>
                <div id="hour-2" class="timeline-bar" title="2 AM"></div>
                <div id="hour-3" class="timeline-bar" title="3 AM"></div>
                <div id="hour-4" class="timeline-bar" title="4 AM"></div>
                <div id="hour-5" class="timeline-bar" title="5 AM"></div>
                <div id="hour-6" class="timeline-bar" title="6 AM"></div>
                <div id="hour-7" class="timeline-bar" title="7 AM"></div>
                <div id="hour-8" class="timeline-bar" title="8 AM"></div>
                <div id="hour-9" class="timeline-bar" title="9 AM"></div>
                <div id="hour-10" class="timeline-bar" title="10 AM"></div>
                <div id="hour-11" class="timeline-bar" title="11 AM"></div>
                <div id="hour-12" class="timeline-bar" title="12 PM"></div>
                <div id="hour-13" class="timeline-bar" title="1 PM"></div>
                <div id="hour-14" class="timeline-bar" title="2 PM"></div>
                <div id="hour-15" class="timeline-bar" title="3 PM"></div>
                <div id="hour-16" class="timeline-bar" title="4 PM"></div>
                <div id="hour-17" class="timeline-bar" title="5 PM"></div>
                <div id="hour-18" class="timeline-bar" title="6 PM"></div>
                <div id="hour-19" class="timeline-bar" title="7 PM"></div>
                <div id="hour-20" class="timeline-bar" title="8 PM"></div>
                <div id="hour-21" class="timeline-bar" title="9 PM"></div>
                <div id="hour-22" class="timeline-bar" title="10 PM"></div>
                <div id="hour-23" class="timeline-bar" title="11 PM"></div>
            </div>

            <!-- Timeline Labels -->
            <div class="timeline-labels">
                <span>12 AM</span>
                <span>4 AM</span>
                <span>8 AM</span>
                <span>12 PM</span>
                <span>4 PM</span>
                <span>8 PM</span>
            </div>

            <div class="mt-6">
                <p class="text-sm font-semibold">Legend:</p>
                <ul class="list-disc list-inside mt-2 text-muted-foreground text-sm">
                    <li class="flex items-center"><div class="w-3 h-3 rounded-full mr-2" style="background-color: #4CAF50;"></div>Low Traffic</li>
                    <li class="flex items-center"><div class="w-3 h-3 rounded-full mr-2" style="background-color: #FFC107;"></div>Medium Traffic</li>
                    <li class="flex items-center"><div class="w-3 h-3 rounded-full mr-2" style="background-color: #F44336;"></div>High Traffic</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Footer Navigation -->
    <footer>
        <a href="booking.html" class="nav-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 9.5a2 2 0 0 1 1.7-1h14.6a2 2 0 0 1 1.7 1v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <path d="M11 20v-5a2 2 0 0 1 2-2v0a2 2 0 0 1 2 2v5"/>
                <path d="m18 10-6-6-6 6"/>
            </svg>
            <span>Home</span>
        </a>
        <a href="wallet.html" class="nav-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12H8a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h13"/>
                <path d="M3 14h.01"/>
                <path d="M3 10h.01"/>
                <path d="M3 6h.01"/>
                <path d="M12 2v.01"/>
                <path d="M12 22v.01"/>
                <path d="M21 6v.01"/>
                <path d="M21 18v.01"/>
                <path d="M6 12h.01"/>
                <path d="M18 12h.01"/>
                <rect x="2" y="7" width="20" height="10" rx="2" ry="2"/>
            </svg>
            <span>Wallet</span>
        </a>
        <a href="status.html" class="nav-btn active">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect>
                <path d="M16 2v4a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2V2"></path>
                <line x1="8" y1="12" x2="16" y2="12"></line>
                <line x1="8" y1="16" x2="16" y2="16"></line>
            </svg>
            <span>Status</span>
        </a>
        <button id="sos-btn" class="nav-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            <span>SOS</span>
        </button>
    </footer>

    <!-- Success Popup
    <div id="action-success-popup" class="popup-overlay">
        <div class="popup-content">
            <div class="success-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>
            <h2 id="popup-message">Action Successful!</h2>
        </div>
    </div> -->

    <!-- Floating Chat Button -->
    <a href="chat.html" class="chat-fab" aria-label="Open AI Assistant">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
    </a>

    <!-- The "brain" for the pooling feature, loaded before the main script runs -->
    <script src="spr-pool-manager.js"></script>

    <script>
        // Data for localities
        const localities = {
            "Tirupati": {
                description: "Tirupati is a major pilgrimage and urban center. Traffic is generally high due to pilgrims and city commuters, especially around temples and the city center.",
                rushHours: {
                    morning: [7, 8, 9],
                    evening: [17, 18, 19]
                }
            },
            "Chandragiri": {
                description: "A more rural area with moderate traffic. Rush hours are mainly influenced by morning and evening office and school commutes.",
                rushHours: {
                    morning: [8],
                    evening: [18]
                }
            },
            "Srikalahasti": {
                description: "Known for the Srikalahasteeswara Temple, this town experiences high pilgrim traffic. Peak hours are influenced by temple darshan timings and local business.",
                rushHours: {
                    morning: [7, 8],
                    evening: [17, 18]
                }
            },
            "Renigunta": {
                description: "A major junction and transport hub, mainly affected by railway and airport traffic. Rush hours are tied to train and flight schedules.",
                rushHours: {
                    morning: [6, 7],
                    evening: [17, 18]
                }
            }
        };

        // Data for TTD calendar rush days
        const ttdCalendar = {
            // Placeholder data for TTD Brahmotsavam festival
            // This is a sample representation, as festival dates vary each year
            "Brahmotsavam": { month: 9, days: [18, 19, 20, 21, 22] }, 
            "Vaikunta Ekadasi": { month: 12, days: [24] }
        };

        // DOM elements
        const localitySelect = document.getElementById('locality-select');
        const localityDescription = document.getElementById('locality-description');
        const timelineBars = document.querySelectorAll('.timeline-bar');
        const statusMessage = document.getElementById('status-message');
        const statusReasons = document.getElementById('status-reasons');
        const statusIcon = document.getElementById('status-icon');
        const poolStatusContainer = document.getElementById('pool-status-container');
        const successPopup = document.getElementById('action-success-popup');
        const popupMessage = document.getElementById('popup-message');


        // --- Smart Predictive Ride Pooling (SPR) ---

        function renderPoolStatus() {
            // Use the new manager to get the user's current pool
            const myPool = SPR_POOL_MANAGER.getMyJoinedPool();

            if (!myPool) {
                // Explicitly show the 'no pools' message.
                poolStatusContainer.innerHTML = `
                <div class="flex items-center justify-between p-4 rounded-xl border-2 border-dashed" style="border-color: hsl(var(--border));">
                    <p class="text-lg" style="color: hsl(var(--muted-foreground));">You haven't joined any pools.</p>
                    <a href="booking.html">
                        <button class="px-4 py-2 btn-primary font-semibold rounded-xl hover:opacity-90 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2">
                            Find a Pool
                        </button>
                    </a>
                </div>`;
                return;
            }

            const departure = new Date(myPool.departureTime);
            const timeString = departure.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            let statusHTML = '';

            if (myPool.status === 'PENDING') {
                statusHTML = `
                    <h3 class="text-xl font-bold mb-2">${myPool.destination}</h3>
                    <p class="text-muted-foreground mb-4">Departs at ${timeString}</p>
                    <div class="text-left">
                        <p class="mb-2"><strong>Status:</strong> <span class="text-yellow-500 font-semibold">Waiting for more passengers or a driver.</span></p>
                        <p><strong>Passengers:</strong> ${myPool.passengers.length} / ${myPool.capacity}</p>
                        <button class="btn-exit-pool" data-pool-id="${myPool.poolId}">Exit Pool</button>
                    </div>
                `;
            } else if (myPool.status === 'ACCEPTED') {
                statusHTML = `
                    <h3 class="text-xl font-bold mb-2">${myPool.destination}</h3>
                    <p class="text-muted-foreground mb-4">Departs at ${timeString}</p>
                    <div class="text-left">
                        <p class="mb-2"><strong>Status:</strong> <span class="text-blue-500 font-semibold">Driver assigned! Waiting for more passengers.</span></p>
                        <p class="mb-2"><strong>Driver:</strong> ${myPool.driverName}</p>
                        <p><strong>Passengers:</strong> ${myPool.passengers.length} / ${myPool.capacity}</p>
                        <button class="btn-exit-pool" data-pool-id="${myPool.poolId}">Exit Pool</button>
                    </div>
                `;
            } else if (myPool.status === 'CONFIRMED') {
                 statusHTML = `
                    <h3 class="text-xl font-bold mb-2">${myPool.destination}</h3>
                    <p class="text-muted-foreground mb-4">Departs at ${timeString}</p>
                    <div class="text-left">
                        <p class="mb-2"><strong>Status:</strong> <span class="text-green-500 font-semibold">Confirmed!</span></p>
                        <p class="mb-2"><strong>Driver:</strong> ${myPool.driverName}</p>
                        <p><strong>Passengers:</strong> ${myPool.passengers.length} / ${myPool.capacity}</p>
                        <p class="text-sm mt-4" style="color: hsl(var(--muted-foreground));">You cannot exit a confirmed pool.</p>
                    </div>
                `;
            } else {
                 statusHTML = `
                    <h3 class="text-xl font-bold mb-2">${myPool.destination}</h3>
                    <p class="text-muted-foreground mb-4">This trip is ${myPool.status.toLowerCase()}.</p>
                `;
            }

            poolStatusContainer.innerHTML = statusHTML;

            // Add event listener for the exit button if it exists
            const exitBtn = poolStatusContainer.querySelector('.btn-exit-pool');
            if (exitBtn) {
                exitBtn.addEventListener('click', (e) => {
                    handleExitPool(e.target.dataset.poolId);
                });
            }
        }

        function showSuccessPopup(message) {
            popupMessage.textContent = message;
            successPopup.classList.add('show');
            setTimeout(() => {
                successPopup.classList.remove('show');
                renderPoolStatus(); // Re-render the status card instead of reloading
            }, 1500); // Show for 1.5 seconds
        }

        function handleExitPool(poolId) {
            if (confirm("Are you sure you want to leave this pool?")) {
                const result = SPR_POOL_MANAGER.exitPool(poolId);
                if (result.success) {
                    showSuccessPopup(result.message);
                } else {
                    alert(result.message); // Use standard alert for errors
                }
            }
        }

        // Function to update the timeline
        function updateTimeline(locality) {
            const data = localities[locality];
            localityDescription.textContent = data.description;

            timelineBars.forEach((bar, index) => {
                bar.classList.remove('low', 'medium', 'high');
                let trafficClass = 'low';

                if (data.rushHours.morning.includes(index) || data.rushHours.evening.includes(index)) {
                    trafficClass = 'high';
                } else if (
                    (index >= 6 && index <= 9) || 
                    (index >= 16 && index <= 19)
                ) {
                    trafficClass = 'medium';
                }

                bar.classList.add(trafficClass);
            });
        }
        
        // Function to check if today is a rush day based on TTD calendar
        function checkRushDay() {
            const today = new Date();
            const todayMonth = today.getMonth() + 1; // getMonth() is 0-indexed
            const todayDate = today.getDate();
            const todayDay = today.getDay(); // 0 for Sunday, 6 for Saturday

            let isRushDay = false;
            let reasons = [];

            // Check for weekends
            if (todayDay === 0 || todayDay === 6) {
                isRushDay = true;
                reasons.push("It's a weekend, leading to increased pilgrim and tourist footfall.");
            }

            // Check for TTD calendar events
            for (const event in ttdCalendar) {
                if (ttdCalendar[event].month === todayMonth && ttdCalendar[event].days.includes(todayDate)) {
                    isRushDay = true;
                    reasons.push(`It's the '${event}' festival, a major event that attracts a large number of pilgrims.`);
                }
            }

            if (isRushDay) {
                statusMessage.textContent = "It's a RUSH day. Expect higher traffic and longer wait times.";
                statusMessage.classList.add('text-red-500');
                statusIcon.innerHTML = `<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>`; // Warning icon
                statusReasons.innerHTML = reasons.map(r => `<li>${r}</li>`).join('');
            } else {
                statusMessage.textContent = "Today is a NORMAL day. Traffic is expected to be as usual.";
                statusMessage.classList.remove('text-red-500');
                statusMessage.classList.add('text-green-500');
                statusIcon.innerHTML = `<circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path>`; // Info icon
                statusReasons.innerHTML = '';
            }
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'night';
            document.documentElement.setAttribute('data-theme', savedTheme);

            // All initialization logic now runs after the DOM is ready and spr-pool-manager.js is loaded.
            SPR_POOL_MANAGER.init();
            checkRushDay();
            renderPoolStatus();
            updateTimeline(localitySelect.value);
        });

        // Event listener for dropdown
        localitySelect.addEventListener('change', (event) => {
            updateTimeline(event.target.value);
        });

        // Listen for storage changes to auto-refresh
        window.addEventListener('storage', () => {
            console.log('Storage changed, re-rendering pool status...');
            renderPoolStatus();
        });

        // SOS Modal functionality
        const sosBtn = document.getElementById('sos-btn');
        if (sosBtn) {
            sosBtn.addEventListener('click', () => {
                const modal = document.createElement('div');
                modal.classList.add('modal', 'visible');
                modal.innerHTML = `
                    <div class="modal-content">
                        <span class="close-btn" onclick="this.parentElement.parentElement.classList.remove('visible')">&times;</span>
                        <h3>Emergency Assistance</h3>
                        <p>In case of an emergency, you can immediately contact the police or a hospital.</p>
                        <div class="contact-info">
                            <a href="tel:100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2.02 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 3.08 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                                </svg>
                                <span>Call Police: 100</span>
                            </a>
                            <a href="tel:108">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2.02 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 3.08 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                                </svg>
                                <span>Call Ambulance: 108</span>
                            </a>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            });
        }
        
        // Theme toggle functionality
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const htmlElement = document.documentElement;
        const themes = ['night', 'day', 'afternoon', 'evening'];

        // Toggle theme on button click
        themeToggleBtn.addEventListener('click', () => {
            const currentTheme = htmlElement.getAttribute('data-theme');
            const currentIndex = themes.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % themes.length;
            const newTheme = themes[nextIndex];
            htmlElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        });
    </script>

</body>
</html>
